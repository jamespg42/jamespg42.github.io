/**
 * Agar.io
 * I'm A Ninja! (Chris X)
 * 
 * Feel free to sumbit names in the Tips and Feedback section!
*/

frameRate(30);
var f = 0;

var w = width, h = height;

var player = {name:""};
var CPUs = [];
var nCPUs = 15;

var started = false;
var typing = false;
var leaderboard = true;
var lineFlash = 0; //for typing
var gobd = 255; //game-over background density

var fw = 150; //field width
var fh = 150; //field height
var ppu = 15; //pixels per unit
var spf = 75; //squares per food

var foods = [];
var nameList = [
"","","","","","United Kingdom","USA","Texas","Mexico","Canada","Ireland","Denmark","Italy","Japan","Brazil","Quebec","Germany","German Empire","North Korea","France","Norway","Iran","Iraq","Ukraine","Portugal","Taiwan","Russia","Tsarist Russia","Switzerland","Qing Dynasty","Australia","Nigeria","Estonia","Poland","Spain","Sweden","Stalin","KC","Piccolo","Confederate","CIA","USSR","Yaranaika","reddit","4chan","8ch","9gag","tumblr","Earth","Moon","Steam","FacePunch","origin","Patriarchy","Feminism","Vinesauce","Stussy","PewDiePie","ayy lmao","sanik","doge","wojac","Bait","Sir","Kim Jong Un","Mao","blue is best","feed me","lel","Ctrl-W for chat","Alt-F4 to win","Obama","ur mom","W for team","God","China","South Korea","Greece","Latvia","Lithuania","Finland","Maldivas","Austria","Indiana","Bulgaria","Hong Kong","Jamaica","Croatia","Chile","Indonesia","Bangladesh","Thailand","Peru","Botswana","Bosnia","Netherlands","European Union","Pakistan","Hungary","Matriarchy","Prodota","Cambodia","NASA","Donald Trump","Donald Gump","Forest Trump","Markiplier","KINGBODIL48","KINGBODIL","******","W = Noob","TeamsRUs","an unnamed cell","Xx_MLG_xX69","Trees Nuts","Ebola","Swagnemite","420 Blaze","Lol","Shrek","Hillary Clinton","AFK","Feed me","U MAD","Swag","PewDieDied","awesomeness"];

var randomColor = function() {
    var colorNumber = floor(random(5.99));
    if (colorNumber === 0) {
        return [255,0,0];
    } else if (colorNumber === 1) {
        return [255,128,0];
    } else if (colorNumber === 2) {
        return [255,255,0];
    } else if (colorNumber === 3) {
        return [0,255,0];
    } else if (colorNumber === 4) {
        return [0,0,255];
    } else if (colorNumber === 5) {
        return [255,0,255];
    }
};
var randomName = function() {
    var x = floor(random(0,nameList.length-0.01));
    return nameList[x];
};

var cpu = function(x,y,size,moveX,moveY,color,name) {
    this.x = x;
    this.y = y;
    this.size = size;
    this.moveX = moveX;
    this.moveY = moveY;
    this.color = color;
    this.name = name;
};
var addCPU = function(x) {
    var CPUSize;
    if (x) {CPUSize = floor(random(9,100));}
    else {CPUSize = 9;}
    
    var newCPU = new cpu(random(3,fw-3),random(3,fh-3),CPUSize,random(3,fw-3),random(3,fh-3),randomColor(),randomName());
    CPUs.push(newCPU);
};

var start = function() {
    player.x = random(3,fw-3);
    player.y = random(3,fh-3);
    player.size = 9;
    player.color = randomColor();
    
    while (CPUs.length < nCPUs) {
        addCPU(true);
    }
    
    started = true;
};

var movePlayer = function() {
    var dx = (mouseX - w/2)/3;
    var dy = (mouseY - h/2)/3;
    var maxSpeed = 1200 / (player.size+40) + 3;
    var distSq = dx*dx + dy*dy;
    if (distSq > maxSpeed*maxSpeed) {
        var ratio = maxSpeed / sqrt(distSq);
        dx *= ratio;
        dy *= ratio;
    }
    player.x += dx/30;
    player.y += dy/30;
};

var moveCPU = function(i) {
    var dx = (CPUs[i].moveX - CPUs[i].x)/3;
    var dy = (CPUs[i].moveY - CPUs[i].y)/3;
    var maxSpeed = 1200 / (CPUs[i].size+40) + 3;
    var ratio = maxSpeed / sqrt(dx*dx + dy*dy);
    dx *= ratio;
    dy *= ratio;
    CPUs[i].x += dx/30;
    CPUs[i].y += dy/30;
};

var targetFood = function(i) {
    /*
    //move to random food
    var randomFood = floor(random(0,fw*fh/spf));
    CPUs[i].moveX = foods[randomFood].x;
    CPUs[i].moveY = foods[randomFood].y;
    */
 
    /*
    //move to random location
    CPUs[i].moveX = floor(random(0,fw));
    CPUs[i].moveY = floor(random(0,fh));
    */
    
    //move in random direction
    var randDir = random(0,360);
    CPUs[i].moveX = CPUs[i].x+random(0,fw)*cos(randDir);
    CPUs[i].moveY = CPUs[i].y+random(0,fh)*sin(randDir);
};

var adjustPPU = function() {
    ppu = 45 / sqrt(sqrt(player.size));
    var lwh = w; //lesser of width and height
    if (h < w) {lwh = h;}
    if (ppu*sqrt(player.size) > lwh*3/4) {
        ppu = lwh*3/4/sqrt(player.size);
    }
    
    /*
    //testing purposes
    if (mouseIsPressed) {ppu = 1;}
    */
};

var food = function(x,y,color) {
    this.x = x;
    this.y = y;
    this.color = color;
};
var addFood = function() {
    var newFood = new food(random(1,fw-1),random(1,fh-1),randomColor());
    foods.push(newFood);
};

//for leaderboard sorting
var comp = function(a,b) {
    return b.size - a.size;
};

var mouseReleased = function() {
    if (!typing && !started && mouseX > w/2-125 && mouseX < w/2+125 && mouseY > h/2-70 && mouseY < h/2-35) {
        typing = true;
    } else if (typing && (mouseX < w/2-125 || mouseX > w/2+125 || mouseY < h/2-70 || mouseY > h/2-35)) {
        typing = false;
    }
    if (!started && mouseX > w/2-125 && mouseX < w/2+125 && mouseY > h/2-20 && mouseY < h/2+20) {
        start();
    }
};
var keyPressed = function() {
    if (typing) {
        if (keyCode === 8) {
            player.name = player.name.substring(0,player.name.length-1);
        } else if ((keyCode < 47 || (keyCode > 111 && keyCode < 146) || (keyCode > 90 && keyCode < 94)) && keyCode !== 32) {
        } else if (player.name.length < 15) {
            player.name += key.toString();
        }
    } else if (started) {
        if (keyCode === 76) {
            leaderboard = !leaderboard;
        }
    }
};

var draw = function() {
    f++;
    if (!started) {
        //death fade
        if (gobd < 255) {
            gobd += 5;
        }
        background(150,150,150,gobd);
        
        stroke(200,200,200);
        fill(255,255,255);
        rect(w/2-150,h/2-150,300,300,15);
        textAlign(CENTER,CENTER);
        textSize(30);
        fill(0,0,0);
        text("Agar.io",w/2,h/2-100);
        fill(255,255,255);
        rect(w/2-125,h/2-70,250,35,4);
        textSize(14);
        textAlign(LEFT,CENTER);
        if (player.name.length === 0) {
            fill(85,85,85);
            text("Nick",w/2-114,h/2-53);
        }
        if (typing || player.name.length > 0) {
            fill(0,0,0);
            if (lineFlash < 15 && typing) {
                text(player.name + "|",w/2-115,h/2-53);
            } else {
                text(player.name,w/2-115,h/2-53);
            }
            lineFlash++;
            if (lineFlash > 30) {lineFlash = 0;}
        }
        textAlign(CENTER,CENTER);
        fill(66,139,202);
        if (mouseX > w/2-125 && mouseX < w/2+125 && mouseY > h/2-20 && mouseY < h/2+20) {
            fill(48,113,169);
        }
        rect(w/2-125,h/2-20,250,40,4);
        fill(255,255,255);
        textSize(14);
        text("Play",w/2,h/2);
        stroke(238,238,238);
        line(w/2-125,h/2+43,w/2+125,h/2+43);
        fill(119,119,119);
        text("Move your mouse to control your cell",w/2,h/2+70);
        text("Press L to toggle leaderboard",w/2,h/2+90);
        text("Sorry, no splitting or ejecting",w/2,h/2+110);
        
        //add food
        while (foods.length < fw*fh/spf) {
            addFood();
        }
        
        //add CPUs
        while(CPUs.length < nCPUs) {
            addCPU(false);
        }
    } else {
        background(255,255,255);
        
        var sps = sqrt(player.size);
        
        if (sps > fw || sps > fh) {
            started = false;
            player.name = "You win!";
            CPUs = [];
        }
        
        //self-explanatory
        movePlayer();
        
        //zooming out to fit player circle on screen
        adjustPPU();
        
        //make sure the player doesn't go off the map
        if (player.x < sps/2) {
            player.x = sps/2;
        } else if (player.x > fw-sps/2) {
            player.x = fw - sps/2;
        }
        if (player.y < sps/2) {
            player.y = sps/2;
        } else if (player.y > fh-sps/2) {
            player.y = fh - sps/2;
        }
        
        pushMatrix();
        translate(w/2-player.x*ppu,h/2-player.y*ppu);
        
        //grid
        stroke(200,200,200);
        for (var i = 0; i <= fw; i += 2) {
            line(i*ppu,0,i*ppu,fh*ppu);
        }
        for (var i = 0; i <= fh; i += 2) {
            line(0,i*ppu,fw*ppu,i*ppu);
        }
        
        //food (can cause lag)
        noStroke();
        //draw all food
        for (var i = 0; i < foods.length; i++) {
            fill(foods[i].color[0], foods[i].color[1], foods[i].color[2]);
            ellipse(foods[i].x*ppu,foods[i].y*ppu,ppu,ppu);
        }
        //check if food has been eaten
        for (var i = 0; i < foods.length; i++) {
            //player circle equation:
            //(x-player.x*ppu)^2+(y-player.y*ppu)^2 < (sps*ppu/2)^2
            if ((foods[i].x*ppu-player.x*ppu)*(foods[i].x*ppu-player.x*ppu) + (foods[i].y*ppu-player.y*ppu)*(foods[i].y*ppu-player.y*ppu) < (sps*ppu/2)*(sps*ppu/2)) {
                foods.splice(i,1);
                player.size++;
                addFood();
                break; //Try to get rid of null-point problems
            }
        }
        
        //CPUs
        //drawing CPUs
        for (var i = 0; i < CPUs.length; i++) {
            fill(CPUs[i].color[0]*0.85, CPUs[i].color[1]*0.85, CPUs[i].color[2]*0.85);
            ellipse(CPUs[i].x*ppu,CPUs[i].y*ppu,sqrt(CPUs[i].size)*ppu,sqrt(CPUs[i].size)*ppu);
            fill(CPUs[i].color[0], CPUs[i].color[1], CPUs[i].color[2]);
            ellipse(CPUs[i].x*ppu,CPUs[i].y*ppu,sqrt(CPUs[i].size)*ppu-12,sqrt(CPUs[i].size)*ppu-12);
            textSize(sqrt(CPUs[i].size)*ppu/5);
            fill(0,0,0);
            text(CPUs[i].name,CPUs[i].x*ppu-1,CPUs[i].y*ppu+1);
            fill(255,255,255);
            text(CPUs[i].name,CPUs[i].x*ppu,CPUs[i].y*ppu);
        }
        for (var i = 0; i < CPUs.length; i++) {
            //making sure CPUs don't go off the map
            var scs = sqrt(CPUs[i].size);
            if (CPUs[i].x < scs/2) {
                CPUs[i].x = scs/2;
            } else if (CPUs[i].x > fw-scs/2) {
                CPUs[i].x = fw - scs/2;
            }
            if (CPUs[i].y < scs/2) {
                CPUs[i].y = scs/2;
            } else if (CPUs[i].y > fh-scs/2) {
                CPUs[i].y = fh - scs/2;
            }
            
            //eating food
            if (f % 15 === 0) {
                CPUs[i].size += floor(random(0,4));
                targetFood(i);
            }
            
            //CPU size control
            if (f % 60 === 0 && random(0,1) > 0.5) {
                CPUs[i].size -= min(floor(CPUs[i].size*0.02),5); //decrease CPU size by 2% every second
                if (CPUs[i].size < 15) {CPUs[i].size = 15;} //minimum size
            }
            
            //Eating CPUs
            //----------------
            //player circle equation:
            //(x-player.x*ppu)^2+(y-player.y*ppu)^2 < (sps*ppu/2)^2
            if ((CPUs[i].x*ppu-player.x*ppu)*(CPUs[i].x*ppu-player.x*ppu) + (CPUs[i].y*ppu-player.y*ppu)*(CPUs[i].y*ppu-player.y*ppu) < (sps*ppu/2)*(sps*ppu/2) && CPUs[i].size < player.size*2/3) {
                player.size += CPUs[i].size;
                CPUs.splice(i,1);
                addCPU(false);
                break;
            }
            
            //CPUs eating you and/or other CPUs
            //----------------
            //eating other CPUs
            for (var j = 0; j < CPUs.length; j++) {
                if ((CPUs[j].x*ppu-CPUs[i].x*ppu)*(CPUs[j].x*ppu-CPUs[i].x*ppu) + (CPUs[j].y*ppu-CPUs[i].y*ppu)*(CPUs[j].y*ppu-CPUs[i].y*ppu) < (sqrt(CPUs[i].size)*ppu/2)*(sqrt(CPUs[i].size)*ppu/2) && CPUs[j].size < CPUs[i].size*2/3) {
                    CPUs[i].size += CPUs[j].size;
                    CPUs.splice(j,1);
                    addCPU(false);
                    break;
                }
            }
            //eating you
            if ((player.x*ppu-CPUs[i].x*ppu)*(player.x*ppu-CPUs[i].x*ppu) + (player.y*ppu-CPUs[i].y*ppu)*(player.y*ppu-CPUs[i].y*ppu) < (sqrt(CPUs[i].size)*ppu/2)*(sqrt(CPUs[i].size)*ppu/2) && player.size < CPUs[i].size*2/3) {
                CPUs[i].size += player.size;
                started = false;
                gobd = 0;
            }
            
            while (abs(CPUs[i].x - CPUs[i].targetX) < 5 && abs(CPUs[i].y - CPUs[i].targetY) < 5) {
                targetFood(i);
            }
            //moving the CPU
            moveCPU(i);
        }
        
        //player circle
        fill(player.color[0]*0.85,player.color[1]*0.85,player.color[2]*0.85);
        ellipse(player.x*ppu,player.y*ppu,sps*ppu,sps*ppu);
        fill(player.color[0],player.color[1],player.color[2]);
        ellipse(player.x*ppu,player.y*ppu,sps*ppu-12,sps*ppu-12);
        textSize(sps*ppu/5);
        fill(0,0,0);
        text(player.name,player.x*ppu-1,player.y*ppu+1);
        fill(255,255,255);
        text(player.name,player.x*ppu,player.y*ppu);
        textSize(sps*ppu/10);
        fill(0,0,0);
        text(player.size,player.x*ppu-1,player.y*ppu+sps*ppu/6+1);
        fill(255,255,255);
        text(player.size,player.x*ppu,player.y*ppu+sps*ppu/6);
        popMatrix();
        
        //leaderboard
        if (leaderboard) {
            fill(0,0,0,150);
            rect(w-145,5,140,129,5);
            fill(255, 255, 255);
            textSize(20);
            text("Leaderboard",w-75,25);
            
            var top5 = [];
            for (var i = 0; i < CPUs.length; i++) {
                top5.push(CPUs[i]);
            }
            top5.push(player);
            top5.sort(comp);
            
            textSize(15);
            for (var i = 0; i < 5; i++) {
                var leaderboardStr = "";
                leaderboardStr += ((i+1) + ". ");
                if (top5[i].name === "") {leaderboardStr += "An unnamed cell";}
                else {leaderboardStr += top5[i].name;}
                fill(255,255,255);
                if (top5[i] === player) {fill(255,150,150);}
                text(leaderboardStr,w-75,53+16*i);
            }
        }
    }
};
